<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Portal - PNL Appointments</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/vue@2.7.14/dist/vue.js"></script>
    <style>
        [v-cloak] {
            display: none;
        }

        .calendar-day {
            min-height: 100px;
            position: relative;
            cursor: default;
        }

        .calendar-day.clickable {
            cursor: pointer;
        }

        .calendar-day.clickable:hover {
            background-color: #f8f9fa;
        }

        .slot-badge {
            font-size: 11px;
            padding: 2px 8px;
            border-radius: 12px;
            display: inline-block;
            margin-top: 4px;
            background-color: #d4edda;
            color: #155724;
            font-weight: 500;
        }

        .today-indicator {
            width: 28px;
            height: 28px;
            border: 2px solid #0d6efd;
            border-radius: 50%;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto;
        }

        .calendar-header {
            background-color: #17a2b8;
            color: white;
        }

        .calendar-header button {
            background-color: transparent;
            border: none;
            color: white;
            padding: 8px;
            border-radius: 4px;
        }

        .calendar-header button:hover {
            background-color: rgba(0, 0, 0, 0.1);
        }

        .days-header {
            background-color: #17a2b8;
            color: white;
        }

        .days-header>div {
            border-right: 1px solid rgba(255, 255, 255, 0.2);
            padding: 12px;
            text-align: center;
            font-size: 14px;
            font-weight: 500;
        }

        .days-header>div:last-child {
            border-right: none;
        }

        .empty-day {
            background-color: #f8f9fa;
        }

        .modal-backdrop-custom {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1050;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .calendar-grid {
            display: flex;
            flex-wrap: wrap;
        }

        .calendar-cell {
            width: 14.2857%;
            flex: 0 0 14.2857%;
        }

        .sticky-form {
            position: sticky;
            top: 20px;
        }
    </style>
</head>

<body class="bg-light">
    <div id="app" v-cloak>
        <div class="container-fluid px-4 py-4">
            <div class="mb-4">
                <h1 class="h2 fw-bold text-dark mb-2">Welcome to the Admin Portal</h1>
                <p class="text-muted">Manage appointment slots and availability</p>
            </div>

            <div class="row g-4">
                <!-- Calendar Section -->
                <div class="col-lg-8">
                    <div class="card shadow-sm border">
                        <div class="calendar-header d-flex align-items-center justify-content-between p-3">
                            <button @click="prevMonth" class="btn">
                                <svg width="20" height="20" fill="currentColor" viewBox="0 0 16 16">
                                    <path fill-rule="evenodd"
                                        d="M11.354 1.646a.5.5 0 0 1 0 .708L5.707 8l5.647 5.646a.5.5 0 0 1-.708.708l-6-6a.5.5 0 0 1 0-.708l6-6a.5.5 0 0 1 .708 0z" />
                                </svg>
                            </button>
                            <h2 class="h5 mb-0 fw-semibold">
                                {{ currentMonthName }} {{ currentYear }}
                            </h2>
                            <button @click="nextMonth" class="btn">
                                <svg width="20" height="20" fill="currentColor" viewBox="0 0 16 16">
                                    <path fill-rule="evenodd"
                                        d="M4.646 1.646a.5.5 0 0 1 .708 0l6 6a.5.5 0 0 1 0 .708l-6 6a.5.5 0 0 1-.708-.708L10.293 8 4.646 2.354a.5.5 0 0 1 0-.708z" />
                                </svg>
                            </button>
                        </div>

                        <div class="days-header d-flex">
                            <div v-for="day in daysOfWeek" :key="day" class="flex-fill">
                                {{ day }}
                            </div>
                        </div>

                        <div class="calendar-grid">
                            <div v-for="(day, index) in calendarDays" :key="index" @click="handleDateClick(day)"
                                :class="getDayClasses(day)" class="calendar-cell border text-center p-2">
                                <div v-if="day.isValid">
                                    <div v-if="day.isToday" class="today-indicator small">
                                        {{ day.day }}
                                    </div>
                                    <div v-else class="small">
                                        {{ day.day }}
                                    </div>
                                    <div v-if="day.hasSlots">
                                        <span class="slot-badge">
                                            {{ getSlotText(day.slots) }}
                                        </span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Add Slot Form -->
                <div class="col-lg-4">
                    <div class="card shadow-sm border sticky-form">
                        <div class="card-body">
                            <h3 class="h5 fw-semibold text-dark mb-3">
                                {{ editMode ? 'Edit Slot' : 'Add New Slot' }}
                            </h3>

                            <div v-if="selectedDateForForm" class="alert alert-info py-2 mb-3">
                                <small class="mb-0 fw-medium">
                                    Selected Date: {{ currentMonthName }} {{ selectedDateForForm.day }}, {{ currentYear
                                    }}
                                </small>
                            </div>

                            <form @submit.prevent="addSlot">
                                <div class="mb-3">
                                    <label class="form-label small fw-medium">Event Type</label>
                                    <select v-model="newSlot.eventType" class="form-select" required>
                                        <option value="">Select Event Type</option>
                                        <option value="nutritionist">Nutritionist session</option>
                                        <option value="psychologist">Psychologist session</option>
                                    </select>
                                </div>


                                <div class="mb-3">
                                    <label class="form-label small fw-medium">Select Date</label>
                                    <input type="date" v-model="newSlot.date" class="form-control" required>
                                </div>

                                <div class="mb-3">
                                    <label class="form-label small fw-medium">Slot Type</label>
                                    <select v-model="newSlot.type" class="form-select" required>
                                        <option value="">Select Type</option>
                                        <option value="individual">Individual</option>
                                        <option value="group">Group</option>

                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label small fw-medium">Capacity (Number of spaces)</label>
                                    <input type="number" min="1" v-model="newSlot.capacity" class="form-control"
                                        required>
                                </div>

                                <div class="row g-2 mb-3">
                                    <div class="col-6">
                                        <label class="form-label small fw-medium">Start Time</label>
                                        <input type="time" v-model="newSlot.startTime" class="form-control" required>
                                    </div>
                                    <div class="col-6">
                                        <label class="form-label small fw-medium">End Time</label>
                                        <input type="time" v-model="newSlot.endTime" class="form-control" required>
                                    </div>
                                </div>

                                <div class="mb-3">
                                    <label class="form-label small fw-medium">Status</label>
                                    <select v-model="newSlot.status" class="form-select" required>
                                        <option value="available">Available</option>
                                        <option value="booked">Booked</option>
                                        <option value="blocked">Blocked</option>
                                    </select>
                                </div>



                                <button type="submit" class="btn btn-info text-white w-100 mb-2">
                                    {{ editMode ? 'Update Slot' : 'Add Slot' }}
                                </button>

                                <button v-if="editMode" @click="cancelEdit" type="button"
                                    class="btn btn-secondary w-100">
                                    Cancel
                                </button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Manage Slots Modal -->
            <div v-if="showModal" class="modal-backdrop-custom" @click.self="closeModal">
                <div class="card shadow-lg"
                    style="max-width: 700px; width: 100%; margin: 0 1rem; max-height: 90vh; overflow-y: auto;">
                    <div class="card-body p-4">
                        <div class="d-flex justify-content-between align-items-start mb-4">
                            <h3 class="h5 fw-semibold text-dark mb-0">
                                Manage Slots - {{ currentMonthName }} {{ selectedDateForForm.day }}, {{ currentYear }}
                            </h3>
                            <div>
                                <button @click="viewAppointments" class="btn btn-sm btn-outline-info me-2">
                                    View Appointments
                                </button>
                                <button @click="closeModal" class="btn-close"></button>
                            </div>
                        </div>

                        <div v-if="selectedDateSlots.length === 0" class="text-center py-5 text-muted">
                            <p>No slots available for this date.</p>
                            <p class="small">Click "Add Slot" to create one.</p>
                        </div>

                        <div v-else>
                            <div v-for="slot in selectedDateSlots" :key="slot.id" class="card mb-3 border">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between align-items-start">
                                        <div class="flex-grow-1">
                                            <div class="d-flex align-items-center gap-2 mb-2">
                                                <span class="badge bg-success text-capitalize">
                                                    {{ slot.type }}
                                                </span>
                                                <span :class="getStatusBadgeClass(slot.status)" class="badge">
                                                    {{ slot.status }}
                                                </span>

                                            </div>
                                            <div class="small text-secondary">
                                                <div><strong>Time:</strong> {{ slot.time }}</div>
                                                <div><strong>Capacity:</strong> {{ slot.capacity }}</div>
                                                <div><strong>Event:</strong> {{ slot.eventType }}</div>
                                            </div>

                                        </div>
                                        <div class="d-flex gap-2">
                                            <button @click="editSlot(slot)" class="btn btn-sm btn-outline-primary">
                                                Edit
                                            </button>
                                            <button @click="deleteSlot(slot.id)" class="btn btn-sm btn-outline-danger">
                                                Delete
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Appointments Modal -->
            <div v-if="showAppointmentsModal" class="modal-backdrop-custom" @click.self="closeAppointmentsModal">
                <div class="card shadow-lg"
                    style="max-width: 700px; width: 100%; margin: 0 1rem; max-height: 90vh; overflow-y: auto;">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-start mb-4">
                            <h3 class="h5 fw-semibold text-dark mb-0">
                                Appointments - {{ selectedDateForForm.day }}/{{ currentMonth+1 }}/{{ currentYear }}
                            </h3>
                            <button @click="closeAppointmentsModal" class="btn-close"></button>
                        </div>

                        <div v-if="appointmentsList.length === 0" class="text-center py-5 text-muted">
                            <p>No appointments booked for this date.</p>
                        </div>

                        <div v-else>
                            <div v-for="appointment in appointmentsList" :key="appointment._id"
                                class="card mb-3 border">
                                <div class="card-body">
                                    <h6 class="fw-semibold">{{ appointment.customerName }}</h6>
                                    <p class="mb-1 small">
                                        <strong>Email:</strong> {{ appointment.email }}<br>
                                        <strong>Phone:</strong> {{ appointment.phone }}<br>
                                        <strong>Type:</strong> {{ appointment.type }}<br>
                                        <strong>Time Booked:</strong> {{ appointment.time }}
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <script>
        new Vue({
            el: '#app',
            data: {
                currentMonth: new Date().getMonth(),
                currentYear: new Date().getFullYear(),
                showModal: false,
                selectedDateForForm: null,
                editMode: false,
                editingSlotId: null,
                daysOfWeek: ['MON', 'TUE', 'WED', 'THU', 'FRI', 'SAT', 'SUN'],
                monthNames: ['JANUARY', 'FEBRUARY', 'MARCH', 'APRIL', 'MAY', 'JUNE',
                    'JULY', 'AUGUST', 'SEPTEMBER', 'OCTOBER', 'NOVEMBER', 'DECEMBER'],
                newSlot: {
                    date: '',
                    type: '',
                    startTime: '',
                    endTime: '',
                    status: 'available',
                    capacity: 1, // default for individual
                    eventType: ''
                },
                appointments: {},
                showAppointmentsModal: false,
                appointmentsList: [],
                nextId: 1
            },
            computed: {
                currentMonthName() {
                    return this.monthNames[this.currentMonth];
                },
                calendarDays() {
                    const firstDay = new Date(this.currentYear, this.currentMonth, 1);
                    const lastDay = new Date(this.currentYear, this.currentMonth + 1, 0);
                    const daysInMonth = lastDay.getDate();
                    const startingDayOfWeek = firstDay.getDay() === 0 ? 6 : firstDay.getDay() - 1;

                    const totalCells = Math.ceil((startingDayOfWeek + daysInMonth) / 7) * 7;
                    const days = [];

                    for (let i = 0; i < totalCells; i++) {
                        const dayNumber = i - startingDayOfWeek + 1;
                        const isValid = dayNumber > 0 && dayNumber <= daysInMonth;

                        if (isValid) {
                            const dateKey = this.formatDateKey(dayNumber);
                            const hasSlots = !!this.appointments[dateKey];
                            const slots = hasSlots ? this.appointments[dateKey].length : 0;
                            const today = new Date();
                            const isToday = dayNumber === today.getDate() &&
                                this.currentMonth === today.getMonth() &&
                                this.currentYear === today.getFullYear();

                            days.push({
                                day: dayNumber,
                                isValid: true,
                                hasSlots: hasSlots,
                                slots: slots,
                                dateKey: dateKey,
                                isToday: isToday
                            });
                        } else {
                            days.push({ isValid: false });
                        }
                    }

                    return days;
                },
                selectedDateSlots() {
                    if (!this.selectedDateForForm) return [];
                    return this.appointments[this.selectedDateForForm.dateKey] || [];
                }
            },
            methods: {
                formatDateKey(day) {
                    const month = String(this.currentMonth + 1).padStart(2, '0');
                    const dayStr = String(day).padStart(2, '0');
                    return this.currentYear + '-' + month + '-' + dayStr;
                },
                formatTime(time) {
                    const parts = time.split(':');
                    const hour = parseInt(parts[0]);
                    const minute = parts[1];
                    const ampm = hour >= 12 ? 'pm' : 'am';
                    const hour12 = hour % 12 || 12;
                    return hour12 + ':' + minute + ' ' + ampm;
                },
                getSlotText(slots) {
                    return slots + (slots === 1 ? ' event' : ' events');
                },
                getStatusBadgeClass(status) {
                    const classes = {
                        'available': 'bg-success',
                        'booked': 'bg-primary',
                        'blocked': 'bg-danger'
                    };
                    return classes[status] || 'bg-secondary';
                },
                getDayClasses(day) {
                    if (!day.isValid) {
                        return 'calendar-day empty-day';
                    }
                    return 'calendar-day clickable bg-white';
                },
                prevMonth() {
                    if (this.currentMonth === 0) {
                        this.currentMonth = 11;
                        this.currentYear--;
                    } else {
                        this.currentMonth--;
                    }
                },
                nextMonth() {
                    if (this.currentMonth === 11) {
                        this.currentMonth = 0;
                        this.currentYear++;
                    } else {
                        this.currentMonth++;
                    }
                },
                handleDateClick(day) {
                    if (day.isValid) {
                        this.selectedDateForForm = day;
                        this.newSlot.date = day.dateKey;
                        this.showModal = true;
                    }
                },
                // ADD or EDIT a slot
                async addSlot() {
                    if (!this.newSlot.date || !this.newSlot.type || !this.newSlot.startTime || !this.newSlot.endTime) {
                        alert("Please fill in all fields");
                        return;
                    }
                    // Time validation
                    if (this.newSlot.startTime >= this.newSlot.endTime) {
                        alert("End time must be greater than start time");
                        return;
                    }

                    // Enforce capacity rules
                    if (this.newSlot.type === 'individual') {
                        this.newSlot.capacity = 1;
                    }

                    if (this.newSlot.type === 'group' && (!this.newSlot.capacity || this.newSlot.capacity < 1)) {
                        alert("Group slots must have a capacity greater than 0");
                        return;
                    }

                    const timeString = this.formatTime(this.newSlot.startTime) + " - " + this.formatTime(this.newSlot.endTime);
                    const payload = {
                        date: this.newSlot.date,
                        type: this.newSlot.type,
                        startTime: this.newSlot.startTime,
                        endTime: this.newSlot.endTime,
                        time: timeString,
                        status: this.newSlot.status,
                        capacity: this.newSlot.capacity,
                        eventType: this.newSlot.eventType
                    };

                    try {
                        let url = "http://localhost:3000/api/slots";
                        let method = "POST";

                        if (this.editMode && this.editingSlotId) {
                            url += `/${this.editingSlotId}`;
                            method = "PUT";
                        }

                        const res = await fetch(url, {
                            method,
                            headers: { "Content-Type": "application/json" },
                            body: JSON.stringify(payload)
                        });

                        let data;
                        if (res.headers.get("content-type")?.includes("application/json")) {
                            data = await res.json();
                        } else {
                            const text = await res.text();
                            throw new Error(text);
                        }

                        if (!res.ok) {
                            throw new Error(data.error || "Failed to save slot");
                        }

                        // Update local appointments
                        if (method === "POST") {
                            if (!this.appointments[this.newSlot.date]) this.$set(this.appointments, this.newSlot.date, []);
                            this.appointments[this.newSlot.date].push({
                                id: data.id,
                                type: payload.type,
                                time: payload.time,
                                status: payload.status
                            });
                            alert("Slot saved successfully!");
                        } else {
                            // PUT / edit
                            const dateKey = this.newSlot.date;
                            const slotIndex = this.appointments[dateKey].findIndex(s => s.id === this.editingSlotId);
                            if (slotIndex !== -1) {
                                this.$set(this.appointments[dateKey], slotIndex, {
                                    id: this.editingSlotId,
                                    type: payload.type,
                                    time: payload.time,
                                    status: payload.status
                                });
                            }
                            alert("Slot updated successfully!");
                        }

                        this.cancelEdit();
                        this.resetForm();
                    } catch (err) {
                        console.error(err);
                        alert('Error saving slot: ' + err.message);
                    }
                },

                // Load all slots
                async loadSlots() {
                    try {
                        const res = await fetch("http://localhost:3000/api/slots");
                        if (!res.ok) throw new Error("Failed to load slots");

                        const slots = await res.json();
                        this.appointments = {};
                        slots.forEach(slot => {
                            if (!this.appointments[slot.date]) {
                                this.$set(this.appointments, slot.date, []);
                            }

                            this.appointments[slot.date].push({
                                id: slot._id.toString(),
                                type: slot.type,
                                time: slot.time,
                                status: slot.status,
                                capacity: slot.capacity ?? 1,
                                eventType: slot.eventType
                            });
                        });
                    } catch (err) {
                        console.error(err);
                        alert("Error loading slots: " + err.message);
                    }
                },


                editSlot(slot) {
                    this.editMode = true;
                    this.editingSlotId = slot.id;
                    this.newSlot.date = this.selectedDateForForm.dateKey;
                    this.newSlot.type = slot.type;
                    this.newSlot.status = slot.status;
                    this.newSlot.eventType = slot.eventType || '';


                    const times = slot.time.split(' - ');
                    this.newSlot.startTime = this.convertTo24Hour(times[0]);
                    this.newSlot.endTime = this.convertTo24Hour(times[1]);

                    this.showModal = false;
                },
                convertTo24Hour(time12h) {
                    const parts = time12h.trim().split(' ');
                    const timeParts = parts[0].split(':');
                    let hour = parseInt(timeParts[0]);
                    const minute = timeParts[1];
                    const ampm = parts[1];

                    if (ampm === 'pm' && hour !== 12) hour += 12;
                    if (ampm === 'am' && hour === 12) hour = 0;

                    return String(hour).padStart(2, '0') + ':' + minute;
                },
                async deleteSlot(slotId) {
                    if (!confirm('Are you sure you want to delete this slot?')) return;

                    try {
                        const res = await fetch(`http://localhost:3000/api/slots/${slotId}`, {
                            method: 'DELETE'
                        });

                        // Check if response is JSON or fallback to text
                        let data;
                        if (res.headers.get("content-type")?.includes("application/json")) {
                            data = await res.json();
                        } else {
                            const text = await res.text();
                            throw new Error(text);
                        }

                        if (!res.ok) {
                            throw new Error(data.error || "Failed to delete slot");
                        }

                        // Remove slot from local appointments
                        const dateKey = this.selectedDateForForm.dateKey;
                        this.appointments[dateKey] = this.appointments[dateKey].filter(s => s.id !== slotId);
                        if (this.appointments[dateKey].length === 0) delete this.appointments[dateKey];

                        alert('Slot deleted successfully!');
                    } catch (err) {
                        console.error(err);
                        alert('Error deleting slot: ' + err.message);
                    }
                },

                cancelEdit() {
                    this.editMode = false;
                    this.editingSlotId = null;
                    this.resetForm();
                },
                resetForm() {
                    this.newSlot = {
                        date: '',
                        type: '',
                        startTime: '',
                        endTime: '',
                        status: 'available'
                    };
                },
                closeModal() {
                    this.showModal = false;
                    this.selectedDateForForm = null;
                },
                async viewAppointments() {
                    if (!this.selectedDateForForm) return;

                    try {
                        const res = await fetch(`http://localhost:3000/api/appointments?date=${this.selectedDateForForm.dateKey}`);
                        if (!res.ok) throw new Error("Failed to fetch appointments");

                        this.appointmentsList = await res.json();
                        this.showAppointmentsModal = true;
                    } catch (err) {
                        console.error(err);
                        alert("Error loading appointments: " + err.message);
                    }
                },

                closeAppointmentsModal() {
                    this.showAppointmentsModal = false;
                    this.appointmentsList = [];
                },
            },
            mounted() {
                const today = new Date();
                const month = String(today.getMonth() + 1).padStart(2, '0');
                const day = String(today.getDate()).padStart(2, '0');
                this.newSlot.date = today.getFullYear() + '-' + month + '-' + day;
                this.loadSlots();
            }
        });
    </script>
</body>

</html>